(function(){"use strict";(function(){function L(){const e=performance.now()/1e3;return Math.round(e*1e4)/1e4}let i=0,u=0,g=0,a=.5;const h=new Map,b=.1,A=new BroadcastChannel("strudeltick"),E=(e,s)=>{A.postMessage({type:e,payload:s})},w=C(L,(e,s,t,n)=>{const r=u*s,l=e-n,c=n+l,_=r*a,d=i+_,m=n-c-s,y=s*a,p=d+y,k=d+m*a;E("tick",{begin:d,end:p,cps:a,tickdeadline:l,num_cycles_at_cps_change:i,num_seconds_at_cps_change:g,num_seconds_since_cps_change:r,cycle:k}),u++},b);let f=!1;const I=e=>{h.set(e,{started:!0}),!f&&(w.start(),f=!0)},O=async e=>{h.set(e,{started:!1});const s=Array.from(h.values()).some(t=>t.started);!f||s||(w.stop(),M(0),f=!1)},M=e=>{u=0,i=e},T=e=>{const{type:s,payload:t}=e;switch(s){case"cpschange":{if(t.cps!==a){const n=u*b;i=i+n*a,g=g+n,a=t.cps,u=0}break}case"setcycle":{M(t.cycle);break}case"toggle":{t.started?I(e.id):O(e.id);break}}};self.onconnect=function(e){const s=e.ports[0];s.addEventListener("message",function(t){T(t.data)}),s.start()};function C(e,s,t=.05,n=.1,r=.1){let l=0,c=0,_=10**4,d=.01;const m=o=>t=o(t);r=r||n/2;const y=()=>{const o=e(),D=o+n+r;for(c===0&&(c=o+d);c<D;)c=Math.round(c*_)/_,c>=o&&s(c,t,l,o),c<o&&console.log("TOO LATE",c),c+=t,l++};let p;const k=()=>{v(),y(),p=setInterval(y,n*1e3)},v=()=>p!==void 0&&clearInterval(p);return{setDuration:m,start:k,stop:()=>{l=0,c=0,v()},pause:()=>v(),duration:t,interval:n,getPhase:()=>c,minLatency:d}}})()})();
